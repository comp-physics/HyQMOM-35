name: MATLAB CI

on:
  push:
  pull_request:

jobs:
  test:
    strategy:
      matrix:
        os: [ubuntu-latest]  
    runs-on: ${{ matrix.os }}
    timeout-minutes: 240  

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Cache MATLAB
        id: cache-matlab
        uses: actions/cache@v4
        with:
          path: |
            /usr/local/MATLAB
            ~/.matlab
          key: ${{ runner.os }}-matlab-r2025b-${{ hashFiles('.github/workflows/validate-simulation.yml') }}
          restore-keys: |
            ${{ runner.os }}-matlab-r2025b-
            ${{ runner.os }}-matlab-

      - name: Setup MATLAB
        uses: matlab-actions/setup-matlab@v2
        with:
          cache: true
          products: Parallel_Computing_Toolbox

      - name: Run comprehensive test suite
        uses: matlab-actions/run-command@v2
        with:
          command: "addpath('tests'); exit_code = run_all_tests(); exit(exit_code)"

      - name: Run existing MATLAB tests
        uses: matlab-actions/run-tests@v2
        with:
          test-results-junit: test-results/results.xml
          source-folder: .
          select-by-folder: tests