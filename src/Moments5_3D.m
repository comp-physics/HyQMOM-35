function [M5,C5,S5] = Moments5_3D(M4)
% Moments5_3D computes 3-D HyQMOM closure for Fluxes
%
%   Input:
% M4 = [M000,M100,M200,M300,M400,M010,M110,M210,M310,M020,M120,M220,M030,M130,M040,...
%       M001,M101,M201,M301,M002,M102,M202,M003,M103,M004,M011,M111,M211,M021,M121,...
%       M031,M012,M112,M013,M022]
% 
%   Output:
% M5 = [M500 M410 M320 M230 M140 M401 M302 M203 M104 M311 M221 M131 M212 M113 M122 M050 M041 M032 M023 M014 M005]
% C5 = [C500 C410 C320 C230 C140 C401 C302 C203 C104 C311 C221 C131 C212 C113 C122 C050 C041 C032 C023 C014 C005]
% S5 = [S500 S410 S320 S230 S140 S401 S302 S203 S104 S311 S221 S131 S212 S113 S122 S050 S041 S032 S023 S014 S005]

% Extract mean velocities
umean = M4(2) / M4(1);   % M100/M000
vmean = M4(6) / M4(1);   % M010/M000
wmean = M4(16) / M4(1);  % M001/M000

% Compute central and standardized moments
[C4, S4] = M2CS4_35(M4);

% Extract central moments (compact notation)
C200=C4(3);  C300=C4(4);  C400=C4(5);  C110=C4(7);  C210=C4(8);
C310=C4(9);  C020=C4(10); C120=C4(11); C220=C4(12); C030=C4(13);
C130=C4(14); C040=C4(15); C101=C4(17); C201=C4(18); C301=C4(19);
C002=C4(20); C102=C4(21); C202=C4(22); C003=C4(23); C103=C4(24);
C004=C4(25); C011=C4(26); C111=C4(27); C211=C4(28); C021=C4(29);
C121=C4(30); C031=C4(31); C012=C4(32); C112=C4(33); C013=C4(34);
C022=C4(35);

% Extract standardized moments
S300=S4(4);  S400=S4(5);  S110=S4(7);  S210=S4(8);  S310=S4(9);
S120=S4(11); S220=S4(12); S030=S4(13); S130=S4(14); S040=S4(15);
S101=S4(17); S201=S4(18); S301=S4(19); S102=S4(21); S202=S4(22);
S003=S4(23); S103=S4(24); S004=S4(25); S011=S4(26); S111=S4(27);
S211=S4(28); S021=S4(29); S121=S4(30); S031=S4(31); S012=S4(32);
S112=S4(33); S013=S4(34); S022=S4(35);
%
% Extract density for later use
M000 = M4(1);

% 21 hyqmom closures
S500 = 0.5*S300*(5*S400 - 3*S300^2 - 1);
S050 = 0.5*S030*(5*S040 - 3*S030^2 - 1);
S005 = 0.5*S003*(5*S004 - 3*S003^2 - 1);
%
S320 = ((S030*S300^2)/2 - S030 + S030*(S300^2 - S400 + 1))*S110 + (S400 - (3*S300^2)/2)*S120 + (-(3*S030*S300)/2)*S210 + ((3*S300)/2)*S220 + S030*S310 - S300/2;
S230 = ((S300*S030^2)/2 - S300 + S300*(S030^2 - S040 + 1))*S110 + (S040 - (3*S030^2)/2)*S210 + (-(3*S300*S030)/2)*S120 + ((3*S030)/2)*S220 + S300*S130 - S030/2;
%
S302 = ((S003*S300^2)/2 - S003 + S003*(S300^2 - S400 + 1))*S101 + (S400 - (3*S300^2)/2)*S102 + (-(3*S003*S300)/2)*S201 + ((3*S300)/2)*S202 + S003*S301 - S300/2;
S203 = ((S300*S003^2)/2 - S300 + S300*(S003^2 - S004 + 1))*S101 + (S004 - (3*S003^2)/2)*S201 + (-(3*S300*S003)/2)*S102 + ((3*S003)/2)*S202 + S300*S103 - S003/2;
%
S032 = ((S003*S030^2)/2 - S003 + S003*(S030^2 - S040 + 1))*S011 + (S040 - (3*S030^2)/2)*S012 + (-(3*S003*S030)/2)*S021 + ((3*S030)/2)*S022 + S003*S031 - S030/2;
S023 = ((S030*S003^2)/2 - S030 + S030*(S003^2 - S004 + 1))*S011 + (S004 - (3*S003^2)/2)*S021 + (-(3*S030*S003)/2)*S012 + ((3*S003)/2)*S022 + S030*S013 - S003/2;
%
S410 = (S300 - 2*S300*S400 + (9*S300^3)/4)*S110 + ((5*S400)/2 - (15*S300^2)/4 - 3/2)*S210 + (2*S300)*S310;
S140 = (S030 - 2*S030*S040 + (9*S030^3)/4)*S110 + ((5*S040)/2 - (15*S030^2)/4 - 3/2)*S120 + (2*S030)*S130;
%
S401 = (S300 - 2*S300*S400 + (9*S300^3)/4)*S101 + ((5*S400)/2 - (15*S300^2)/4 - 3/2)*S201 + (2*S300)*S301;
S104 = (S003 - 2*S003*S004 + (9*S003^3)/4)*S101 + ((5*S004)/2 - (15*S003^2)/4 - 3/2)*S102 + (2*S003)*S103;
%
S041 = (S030 - 2*S030*S040 + (9*S030^3)/4)*S011 + ((5*S040)/2 - (15*S030^2)/4 - 3/2)*S021 + (2*S030)*S031;
S014 = (S003 - 2*S003*S004 + (9*S003^3)/4)*S011 + ((5*S004)/2 - (15*S003^2)/4 - 3/2)*S012 + (2*S003)*S013;
%
S311 = 3*(S300*S211)/2 + (2*S400 - 3*S300^2)*S111/2 - (S300*S011)/2;
S131 = 3*(S030*S121)/2 + (2*S040 - 3*S030^2)*S111/2 - (S030*S101)/2;
S113 = 3*(S003*S112)/2 + (2*S004 - 3*S003^2)*S111/2 - (S003*S110)/2;
%
S221 = S300*(S121 - S101) + S030*(S211 - S011) + S201 + S021 - S300*S030*S111;
S212 = S300*(S112 - S110) + S003*(S211 - S011) + S210 + S012 - S300*S003*S111;
S122 = S003*(S121 - S101) + S030*(S112 - S110) + S102 + S120 - S003*S030*S111;
%
% 21 closures for central moments from standardized moments (using utility)
sC200 = sqrt(max(eps,C200));
sC020 = sqrt(max(eps,C020));
sC002 = sqrt(max(eps,C002));

% Batch Sâ†’C conversion for 5th-order closure moments (replaces ~21 lines)
% Note: We need dummy values for orders 2-4 (already computed), only converting order 5
S110_d=0; S101_d=0; S011_d=0; S300_d=0; S210_d=0; S201_d=0; S120_d=0; S111_d=0; S102_d=0; S030_d=0; S021_d=0; S012_d=0; S003_d=0;
S400_d=0; S310_d=0; S301_d=0; S220_d=0; S211_d=0; S202_d=0; S130_d=0; S121_d=0; S112_d=0; S103_d=0; S040_d=0; S031_d=0; S022_d=0; S013_d=0; S004_d=0;
[~,~,~,~,~,~,~,~,~,~,~,~,~,~,~,~,~,~,~,~,~,~,~,~,~,~,~,~,...
 C500,C410,C401,C320,C311,C302,C230,C221,C212,C203,C140,C131,C122,C113,C104,C050,C041,C032,C023,C014,C005] = ...
    moment_conversion_utils('S_to_C_batch',S110_d,S101_d,S011_d,S300_d,S210_d,S201_d,S120_d,S111_d,S102_d,S030_d,S021_d,S012_d,S003_d,...
                            S400_d,S310_d,S301_d,S220_d,S211_d,S202_d,S130_d,S121_d,S112_d,S103_d,S040_d,S031_d,S022_d,S013_d,S004_d,...
                            S500,S410,S401,S320,S311,S302,S230,S221,S212,S203,S140,S131,S122,S113,S104,S050,S041,S032,S023,S014,S005,...
                            sC200,sC020,sC002);
%
% 21 closure moments from central moments
M5 = C5toM5_3D(M000,umean,vmean,wmean,C200,C110,C101,C020,C011,C002,...
               C300,C210,C201,C120,C111,C102,C030,C021,C012,C003,...
               C400,C310,C301,C220,C211,C202,C130,C121,C112,C103,C040,C031,C022,C013,C004,...
               C500,C410,C320,C230,C140,C401,C302,C203,C104,C311,C221,C131,C212,C113,C122,C050,C041,C032,C023,C014,C005);

% Extract only the 5th-order closure moments (replaces ~21 lines)
% We only need moments 36-56 from the M5 array
M500 = M5(6,1,1); M410 = M5(5,2,1); M320 = M5(4,3,1); M230 = M5(3,4,1); M140 = M5(2,5,1);
M401 = M5(5,1,2); M302 = M5(4,1,3); M203 = M5(3,1,4); M104 = M5(2,1,5);
M311 = M5(4,2,2); M221 = M5(3,3,2); M131 = M5(2,4,2); M212 = M5(3,2,3); M113 = M5(2,2,4); M122 = M5(2,3,3);
M050 = M5(1,6,1); M041 = M5(1,5,2); M032 = M5(1,4,3); M023 = M5(1,3,4); M014 = M5(1,2,5); M005 = M5(1,1,6);
%
% moments closures
M5 = [M500 M410 M320 M230 M140 M401 M302 M203 M104 M311 M221 M131 M212 M113 M122 M050 M041 M032 M023 M014 M005]';
C5 = [C500 C410 C320 C230 C140 C401 C302 C203 C104 C311 C221 C131 C212 C113 C122 C050 C041 C032 C023 C014 C005]';
S5 = [S500 S410 S320 S230 S140 S401 S302 S203 S104 S311 S221 S131 S212 S113 S122 S050 S041 S032 S023 S014 S005]';
%
end